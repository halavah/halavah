<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Halavah">



    <meta name="description" content="勿因喜而轻诺！">



<title>6. 集成 Redis 实现本周热议 | Halavah&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 5.3.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Halavah&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Halavah&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">6. 集成 Redis 实现本周热议</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Halavah</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">三月 19, 2020&nbsp;&nbsp;14:59:53</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/blog/">blog</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="6-集成-Redis-实现本周热议"><a href="#6-集成-Redis-实现本周热议" class="headerlink" title="6. 集成 Redis 实现本周热议"></a>6. 集成 Redis 实现本周热议</h2><h3 id="6-1-环境搭建"><a href="#6-1-环境搭建" class="headerlink" title="6.1 环境搭建"></a>6.1 环境搭建</h3><ul>
<li>添加 redis 依赖，使用 utils 包下的 RedisUtil 对内置 RedisTemplate 进行封装</li>
<li>添加 hutool 依赖，使用 DateUtil 类中的 offsetDay()、format()</li>
<li>考虑到 redis 序列化后出现乱码问题，使用 RedisConfig 配置类进行编码的处理<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--Redis--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--hutool：工具包，例如DateUtils工具类...--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 指定Redis的序列化后的格式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> RedisTemplate();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(<span class="keyword">new</span> ObjectMapper());</span><br><span class="line"></span><br><span class="line">        template.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line"></span><br><span class="line">        template.setHashKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        template.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-2-本周热议的【基本原理】：利用-Redis-的-zet-有序集合实现"><a href="#6-2-本周热议的【基本原理】：利用-Redis-的-zet-有序集合实现" class="headerlink" title="6.2 本周热议的【基本原理】：利用 Redis 的 zet 有序集合实现"></a>6.2 本周热议的【基本原理】：利用 Redis 的 zet 有序集合实现</h3></li>
<li>缓存热评文章——哈希表 Hash</li>
<li>评论数量排行——有序列表 sortedSet：ZADD（添加）、ZREVRANGE（展示）、ZUNIONSTORE（并集）<ul>
<li>ZADD key score member [[score member] [score member] …]       <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ZADD day:18 10 post:1 6 post:2 4 post:3</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; ZADD day:19 10 post:1 6 post:2 4 post:3</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; ZADD day:20 10 post:1 6 post:2 4 post:3</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; ZADD day:21 10 post:1 6 post:2 4 post:3</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; ZADD day:22 10 post:1 6 post:2 4 post:3</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; ZADD day:23 10 post:1 6 post:2 4 post:3</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; ZADD day:24 10 post:1 6 post:2 4 post:3</span><br><span class="line">(integer) 3</span><br></pre></td></tr></table></figure></li>
<li>ZREVRANGE key start stop [WITHSCORES]  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ZREVRANGE day:18 0 -1 withscores</span><br><span class="line">1) &quot;post:1&quot;</span><br><span class="line">2) &quot;10&quot;</span><br><span class="line">3) &quot;post:2&quot;</span><br><span class="line">4) &quot;6&quot;</span><br><span class="line">5) &quot;post:3&quot;</span><br><span class="line">6) &quot;4&quot;</span><br></pre></td></tr></table></figure></li>
<li>ZUNIONSTORE destination numkeys key [key …] [WEIGHTS weight [weight …]] [AGGREGATE SUM|MIN|MAX]  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ZUNIONSTORE week:rank 7 day:18 day:19 day:20 day:21 day:22 day:23 day:24</span><br><span class="line">1) &quot;post:1&quot;</span><br><span class="line">2) &quot;post:2&quot;</span><br></pre></td></tr></table></figure></li>
<li>查看排行榜  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ZREVRANGE week:rank 0 -1 withscores</span><br><span class="line">1) &quot;post:1&quot;</span><br><span class="line">2) &quot;70&quot;</span><br><span class="line">3) &quot;post:2&quot;</span><br><span class="line">4) &quot;42&quot;</span><br><span class="line">5) &quot;post:3&quot;</span><br><span class="line">6) &quot;28&quot;</span><br></pre></td></tr></table></figure></li>
<li>添加/删除评论  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ZINCRBY day:18 10 post:1</span><br><span class="line">&quot;20&quot;</span><br><span class="line">127.0.0.1:6379&gt; ZREVRANGE  day:18 0 -1 withscores</span><br><span class="line">1) &quot;post:1&quot;</span><br><span class="line">2) &quot;20&quot;</span><br><span class="line">3) &quot;post:2&quot;</span><br><span class="line">4) &quot;6&quot;</span><br><span class="line">5) &quot;post:3&quot;</span><br><span class="line">6) &quot;4&quot;</span><br><span class="line">127.0.0.1:6379&gt; ZINCRBY day:18 -10 post:1</span><br><span class="line">&quot;10&quot;</span><br></pre></td></tr></table></figure>
<h3 id="6-3-本周热议的【初始化操作】"><a href="#6-3-本周热议的【初始化操作】" class="headerlink" title="6.3 本周热议的【初始化操作】"></a>6.3 本周热议的【初始化操作】</h3></li>
</ul>
</li>
<li>项目启动前，获取【近 7 天文章】</li>
<li>初始化【近 7 天文章】的总评论量（先使用 SortedSet 集合对【排行榜 7 天内全部文章】进行 zadd 操作，并设置它们 expire 为 7 天；再使用 Hash 哈希表对【排行榜 7 天内全部文章】进行 hexists 判断，再 hset 缓存操作）<ul>
<li>添加 add——将【近 7 天文章】创建日期时间作为 key 值，每篇文章对应的 id 作为它的 value 值，每篇文章对应的评论 comment 作为它的 score 值，并使用 redis 的工具类（RedisUtil），对文章的具体属性进行 zSet()缓存操作</li>
<li>过期 expire——让【近 7 天文章】的 key 过期： 7-（当前时间-创建时间）= 过期时间</li>
<li>缓存——缓存【近 7 天文章】的一些基本信息，例如文章 id，标题 title，评论数量，作者信息…方便访问【近 7 天文章】时，直接 redis，而非 MySQL<ul>
<li>先对文章进行 EXISTS 判断其缓存是否存在</li>
<li>如果 false 不存在，则再 hset 缓存操作</li>
</ul>
</li>
</ul>
</li>
<li>对【近 7 天文章】做并集运算（zUnionAndStore）， 并使用根据评论量的数量从大到小进行展示（zrevrange）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Context配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextStartup</span> <span class="keyword">implements</span> <span class="title">ApplicationRunner</span>, <span class="title">ServletContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CategoryService categoryService;</span><br><span class="line"></span><br><span class="line">    ServletContext servletContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PostService postService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 项目启动时，会同时调用该run方法：</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 加载导航栏中的“提问、分享、讨论、建议”，并将其list放入servletContext上下文对象</span></span><br><span class="line"><span class="comment">     * 加载本周热议</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;Category&gt; categories = categoryService.list(<span class="keyword">new</span> QueryWrapper&lt;Category&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;status&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        );</span><br><span class="line">        servletContext.setAttribute(<span class="string">&quot;categorys&quot;</span>, categories);</span><br><span class="line"></span><br><span class="line">        postService.initWeekRank();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * servletContext上下文对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServletContext</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.servletContext = servletContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PostServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">PostMapper</span>, <span class="title">Post</span>&gt; <span class="keyword">implements</span> <span class="title">PostService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 项目启动前，初始化本周热议（近7天全部文章评论量的排行榜）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initWeekRank</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.获取【近7天文章】</span></span><br><span class="line">        List&lt;Post&gt; posts = <span class="keyword">this</span>.list(<span class="keyword">new</span> QueryWrapper&lt;Post&gt;()</span><br><span class="line">                .gt(<span class="string">&quot;created&quot;</span>, DateUtil.offsetDay(<span class="keyword">new</span> Date(), -<span class="number">6</span>))  <span class="comment">//根据created时间，对最近7天内的文章进行筛选</span></span><br><span class="line">                .select(<span class="string">&quot;id, title, user_id, comment_count, view_count, created&quot;</span>) <span class="comment">//对文章的属性进行筛选，加快查询速率</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.初始化【近7天文章】的总评论量（先使用SortedSet集合对【排行榜7天内全部文章】进行zadd操作，并设置它们expire为7天；再使用Hash哈希表对【排行榜7天内全部文章】进行hexists判断，再hset缓存操作）</span></span><br><span class="line">        <span class="keyword">for</span> (Post post : posts) &#123;</span><br><span class="line">            <span class="comment">//1.添加add——|day:rank:20210202--0208|，将【近7天文章】创建日期时间作为key值，每篇文章对应的id作为它的value值，每篇文章对应的评论comment作为它的score值，并使用redis的工具类（RedisUtil），对文章的具体属性进行zSet()缓存操作</span></span><br><span class="line">            String zKey = <span class="string">&quot;day:rank:&quot;</span> + DateUtil.format(post.getCreated(), DatePattern.PURE_DATE_FORMAT);</span><br><span class="line">            redisUtil.zSet(zKey, post.getId(), post.getCommentCount());<span class="comment">//阅读redisUtil工具类，可知zSet等同于zadd</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//2.过期expire——|day:rank:20210202--0208|，让【近7天文章】的key过期： 7-（当前时间-创建时间）= 过期时间</span></span><br><span class="line">            <span class="keyword">long</span> expireTime = (<span class="number">7</span> - DateUtil.between(<span class="keyword">new</span> Date(), post.getCreated(), DateUnit.DAY)) * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line">            redisUtil.expire(zKey, expireTime);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3.缓存——|day:rank:post:1~16|，缓存【近7天文章】的一些基本信息，例如文章id，标题title，评论数量，作者信息...方便访问【近7天文章】时，直接redis，而非MySQL</span></span><br><span class="line">            <span class="comment">//3.1先对文章进行EXISTS判断其缓存是否存在</span></span><br><span class="line">            String hKey = <span class="string">&quot;day:rank:post:&quot;</span> + post.getId();</span><br><span class="line">            <span class="keyword">if</span> (!redisUtil.hasKey(hKey)) &#123;</span><br><span class="line">                <span class="comment">//3.2如果false不存在，则再hset缓存操作</span></span><br><span class="line">                redisUtil.hset(hKey, <span class="string">&quot;post-id&quot;</span>, post.getId(), expireTime);</span><br><span class="line">                redisUtil.hset(hKey, <span class="string">&quot;post-title&quot;</span>, post.getTitle(), expireTime);</span><br><span class="line">                redisUtil.hset(hKey, <span class="string">&quot;post-commentCount&quot;</span>, post.getCommentCount(), expireTime);</span><br><span class="line">                redisUtil.hset(hKey, <span class="string">&quot;post-viewCount&quot;</span>, post.getViewCount(), expireTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.对【近7天文章】做并集运算（zUnionAndStore）， 并使用根据评论量的数量从大到小进行展示（zrevrange）</span></span><br><span class="line">        String currentKey = <span class="string">&quot;day:rank:&quot;</span> + DateUtil.format(<span class="keyword">new</span> Date(), DatePattern.PURE_DATE_FORMAT);</span><br><span class="line">        List&lt;String&gt; otherKeys = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = -<span class="number">6</span>; i &lt; <span class="number">0</span>; i++) &#123;</span><br><span class="line">            String temp = <span class="string">&quot;day:rank:&quot;</span> + DateUtil.format(DateUtil.offsetDay(<span class="keyword">new</span> Date(), i), DatePattern.PURE_DATE_FORMAT);</span><br><span class="line">            otherKeys.add(temp);</span><br><span class="line">        &#125;</span><br><span class="line">        String destKey = <span class="string">&quot;week:rank&quot;</span>;</span><br><span class="line">        redisUtil.zUnionAndStore(currentKey, otherKeys, destKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-4-本周热议的【初始化操作】：自定义标签【hots】"><a href="#6-4-本周热议的【初始化操作】：自定义标签【hots】" class="headerlink" title="6.4 本周热议的【初始化操作】：自定义标签【hots】"></a>6.4 本周热议的【初始化操作】：自定义标签【hots】</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 本周热议</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HotsTemplate</span> <span class="keyword">extends</span> <span class="title">TemplateDirective</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hots&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(DirectiveHandler handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;Map&gt; hostPost = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取有序集 key 中成员 member 的排名，其中有序集成员按 score 值递减 (从大到小) 排序</span></span><br><span class="line">        Set&lt;ZSetOperations.TypedTuple&gt; typedTuples = redisUtil.getZSetRank(<span class="string">&quot;week:rank&quot;</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line">        <span class="keyword">for</span> (ZSetOperations.TypedTuple typedTuple : typedTuples) &#123;</span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//zSet(key， value， score)  -&gt; zSet(文章日期, 文章id, 文章评论数commentCount)，此处取出zSet中的value，即文章id</span></span><br><span class="line">            String postHashKey = <span class="string">&quot;day:rank:post:&quot;</span> + typedTuple.getValue();</span><br><span class="line"></span><br><span class="line">            map.put(<span class="string">&quot;id&quot;</span>, redisUtil.hget(postHashKey, <span class="string">&quot;post-id&quot;</span>));</span><br><span class="line">            map.put(<span class="string">&quot;title&quot;</span>, redisUtil.hget(postHashKey, <span class="string">&quot;post-title&quot;</span>));</span><br><span class="line">            map.put(<span class="string">&quot;commentCount&quot;</span>, redisUtil.hget(postHashKey, <span class="string">&quot;post-commentCount&quot;</span>));</span><br><span class="line">            map.put(<span class="string">&quot;viewCount&quot;</span>, redisUtil.hget(postHashKey, <span class="string">&quot;post-viewCount&quot;</span>));</span><br><span class="line"></span><br><span class="line">            hostPost.add(map);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        handler.put(RESULTS, hostPost).render();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Freemarker配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FreemarkerConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> freemarker.template.Configuration configuration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TimeAgoMethod timeAgoMethod;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    PostsTemplate postsTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    HotsTemplate hotsTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册为“timeAgo”函数：快速实现日期转换</span></span><br><span class="line"><span class="comment">     * 注册为“posts”函数：快速实现分页</span></span><br><span class="line"><span class="comment">     * 注册为&quot;hots&quot;函数：快速实现本周热议</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        configuration.setSharedVariable(<span class="string">&quot;timeAgo&quot;</span>, timeAgoMethod);</span><br><span class="line">        configuration.setSharedVariable(<span class="string">&quot;details&quot;</span>, postsTemplate);</span><br><span class="line">        configuration.setSharedVariable(<span class="string">&quot;hots&quot;</span>, hotsTemplate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-4-本周热议的【更新操作】"><a href="#6-4-本周热议的【更新操作】" class="headerlink" title="6.4 本周热议的【更新操作】"></a>6.4 本周热议的【更新操作】</h3></li>
<li>自增/自减评论数</li>
<li>更新这篇文章的缓存时间，并更新这篇文章的基本信息</li>
<li>对【近 7 天文章】重新做并集运算（zUnionAndStore）， 并使用根据评论量的数量从大到小进行展示（zrevrange）<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PostServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">PostMapper</span>, <span class="title">Post</span>&gt; <span class="keyword">implements</span> <span class="title">PostService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisUtil redisUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本周热议：增加评论后，通过自增/自减评论数、再对排行榜做并集运算</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incrCommentCountAndUnionForWeekRank</span><span class="params">(Post post, <span class="keyword">boolean</span> isIncr)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.自增/自减评论数</span></span><br><span class="line">        String currentKey = <span class="string">&quot;day:rank:&quot;</span> + DateUtil.format(<span class="keyword">new</span> Date(), DatePattern.PURE_DATE_FORMAT);</span><br><span class="line">        redisUtil.zIncrementScore(currentKey, post.getId(), isIncr ? <span class="number">1</span> : -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.更新这篇文章的缓存时间，并更新这篇文章的基本信息</span></span><br><span class="line">        String zKey = <span class="string">&quot;day:rank:&quot;</span> + DateUtil.format(post.getCreated(), DatePattern.PURE_DATE_FORMAT);</span><br><span class="line">        <span class="keyword">long</span> expireTime = (<span class="number">7</span> - DateUtil.between(<span class="keyword">new</span> Date(), post.getCreated(), DateUnit.DAY)) * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line">        redisUtil.expire(zKey, expireTime);</span><br><span class="line">        String hKey = <span class="string">&quot;day:rank:post:&quot;</span> + post.getId();</span><br><span class="line">        <span class="keyword">if</span> (!redisUtil.hasKey(hKey)) &#123;</span><br><span class="line">            <span class="comment">//3.2如果false不存在，则再hset缓存操作</span></span><br><span class="line">            redisUtil.hset(hKey, <span class="string">&quot;post-id&quot;</span>, post.getId(), expireTime);</span><br><span class="line">            redisUtil.hset(hKey, <span class="string">&quot;post-title&quot;</span>, post.getTitle(), expireTime);</span><br><span class="line">            redisUtil.hset(hKey, <span class="string">&quot;post-commentCount&quot;</span>, post.getCommentCount(), expireTime);</span><br><span class="line">            redisUtil.hset(hKey, <span class="string">&quot;post-viewCount&quot;</span>, post.getViewCount(), expireTime);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.对【近7天文章】重新做并集运算（zUnionAndStore）</span></span><br><span class="line">        List&lt;String&gt; otherKeys = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = -<span class="number">6</span>; i &lt; <span class="number">0</span>; i++) &#123;</span><br><span class="line">            String temp = <span class="string">&quot;day:rank:&quot;</span> + DateUtil.format(DateUtil.offsetDay(<span class="keyword">new</span> Date(), i), DatePattern.PURE_DATE_FORMAT);</span><br><span class="line">            otherKeys.add(temp);</span><br><span class="line">        &#125;</span><br><span class="line">        String destKey = <span class="string">&quot;week:rank&quot;</span>;</span><br><span class="line">        redisUtil.zUnionAndStore(currentKey, otherKeys, destKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Java/"># Java</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/Part05-%E9%A1%B9%E7%9B%AE%E5%90%AF%E5%8A%A8%E5%89%8D%E5%8A%A0%E8%BD%BD%E5%AF%BC%E8%88%AA%E6%A0%8F.html">5. 项目启动前预加载导航栏</a>
            
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Halavah | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
